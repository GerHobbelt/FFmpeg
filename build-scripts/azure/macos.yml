steps:
  - checkout: self
  - checkout: topaz-conan-dev
  - checkout: pipeline-helper
    
  - template: set_tools_and_deps.yml
    parameters:
      OS: 'mac'
      SHOULD_RESTORE_CONAN_CACHE: true

  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      git apply ./build-scripts/configure-zimg.patch
      git apply ./build-scripts/configure-aom.patch
      git apply ./build-scripts/mac/configure-ossl.patch
      if [[ "${BUILD_REASON}" == "PullRequest" || -z "${PUBLISH}" ]]; then
        arch -arm64 bash ./build-scripts/mac/build_mac.sh 1 ./builds-arm ./builds-x86 ./builds-univ '' ''
      else
        cd build-scripts/mac/
        arch -arm64 bash ./build_and_publish.sh $(VERSION) _ _ $(Build.SourcesDirectory)/topaz-conan-dev 1
      fi
    displayName: Build
  
  - bash: |
      cp "$(Build.SourcesDirectory)/pipeline-helper/dependency-manager/dependency_viewer.py" "$(Build.SourcesDirectory)/FFmpeg/build-scripts"
      cd "$(Build.SourcesDirectory)/FFmpeg/build-scripts"

      cp ./mac/profile_mac_armv8 ./profile_mac_armv8
      cp ./mac/profile_mac14.0 ./profile_mac_x86_64

      python dependency_viewer.py -os=MAC -ar=armv8 -v="$(VERSION)" -bn="$BUILD_NOTE" -a="$(Build.RequestedFor)" -cf="deploy_conanfile.py"
      python dependency_viewer.py -os=MAC -ar=x86_64 -v="$(VERSION)" -bn="$BUILD_NOTE" -a="$(Build.RequestedFor)" -cf="deploy_conanfile.py"

    condition: and(succeeded(), ne(variables['PUBLISH'], ''))
    displayName: Slack Dependency Manager
    continueOnError: true 
    env:
      DEPENDENCY_MANAGER_SLACK_WEBHOOK: $(DEPENDENCY_MANAGER_SLACK_WEBHOOK)
      BUILD_TYPE: ""

