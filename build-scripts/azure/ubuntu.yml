steps:
  - checkout: self
  - checkout: topaz-conan-dev
  - checkout: nv-codec-headers
  - checkout: pipeline-helper
  
  - template: set_tools_and_deps.yml
    parameters:
      OS: 'linux'
      SHOULD_RESTORE_CONAN_CACHE: true
      
  - bash: |
      cd "$(Build.SourcesDirectory)/nv-codec-headers"
      sudo make install
    displayName: Install nv-codec-headers
      
  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      bash ./build-scripts/linux/conan_linux.sh
    displayName: Install conan packages
    
  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      git apply ./build-scripts/configure-zimg.patch
      git apply ./build-scripts/configure-aom.patch
      git apply ./build-scripts/linux/configure-x264-x265.patch
      echo ./configure --enable-shared --disable-ffplay --disable-libxcb --disable-vulkan --disable-sdl2 --disable-xlib --enable-tvai --enable-libvpx --enable-libaom --enable-libzimg --enable-nvenc --enable-nvdec --extra-cflags="-I./conan/include -I./conan/include/videoai" --extra-ldflags="-Wl,-rpath,./conan/lib/ -L./conan/lib" --prefix=./output-conan/
      set -e
      ./configure --enable-gpl --enable-shared --disable-ffplay --disable-libxcb --disable-vulkan --disable-sdl2 --disable-xlib --enable-tvai --enable-libvpx --enable-libaom --enable-libzimg --enable-nvenc --enable-nvdec --enable-libx264 --enable-libx265  --extra-cflags="-I./conan/include -I./conan/include/videoai" --extra-ldflags="-Wl,-rpath,./conan/lib/ -L./conan/lib" --prefix=./output-conan/
      
      make clean
      make -j$(nproc) install
      
      if [[ "${BUILD_REASON}" == "PullRequest" || -z "${PUBLISH}" ]]; then
        exit 0
      else
        mkdir -p $(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/linux_x86_64/build_type\=Release/
        cp build-scripts/deploy_conanfile.py $(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/conanfile.py
        cp -Rp "output-conan"/* $(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/linux_x86_64/build_type\=Release/
        cd $(Build.SourcesDirectory)/topaz-conan-dev
        bash ./run_publish_prebuilt.sh --package-name topaz-ffmpeg --package-version $(VERSION) -r topaz-conan
      fi
    displayName: Build FFmpeg

  - bash: |
      cp "$(Build.SourcesDirectory)/pipeline-helper/dependency-manager/dependency_viewer.py" "$(Build.SourcesDirectory)/FFmpeg/build-scripts"
      cd "$(Build.SourcesDirectory)/FFmpeg/build-scripts"

      cp ./linux/profile_ubuntu22.04 ./profile_ubuntu22.04

      python dependency_viewer.py -os=LIN -ar=x86_64 -v="$(VERSION)" -bn="$BUILD_NOTE" -a="$(Build.RequestedFor)" -cf="deploy_conanfile.py"
    condition: and(succeeded(), ne(variables['PUBLISH'], ''))
    displayName: Slack Dependency Manager
    continueOnError: true 
    env:
      DEPENDENCY_MANAGER_SLACK_WEBHOOK: $(DEPENDENCY_MANAGER_SLACK_WEBHOOK)
      BUILD_TYPE: ""
