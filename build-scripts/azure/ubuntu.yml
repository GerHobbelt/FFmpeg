steps:
  - checkout: self
  - checkout: topaz-conan-dev
  - checkout: nv-codec-headers
  - checkout: pipeline-helper
  
  - template: set_tools_and_deps.yml
    parameters:
      OS: 'linux'
      SHOULD_RESTORE_CONAN_CACHE: true
      
  - bash: |
      cd "$(Build.SourcesDirectory)/nv-codec-headers"
      sudo make install
    displayName: Install nv-codec-headers
      
  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      bash ./build-scripts/linux/conan_linux.sh
    displayName: Install conan packages

  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      echo "Applying patches..."
      git apply --verbose ./build-scripts/configure-zimg.patch
      git apply --verbose ./build-scripts/configure-aom.patch
      git apply --verbose ./build-scripts/linux/configure-x264-x265.patch
      echo "Patches applied successfully!"
      echo " === Verifying x264/x265 configuration changes..."
      grep -A 2 -B 2 "check_lib.*x264" configure || echo "x264 patch may not have applied correctly"
      grep -A 2 -B 2 "check_lib.*x265" configure || echo "x265 patch may not have applied correctly"
      echo "=== Conan lib directory ==="
      ls -la ./conan/lib/ | grep -E "(x264|x265)" || echo "No x264/x265 found in conan/lib"
      echo "=== System libraries ==="
      ldconfig -p | grep -E "(x264|x265)" || echo "No x264/x265 found in system libraries"
      echo "=== PKG_CONFIG_PATH ==="
      echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
      echo "=== pkg-config search for x264/x265 ==="
      pkg-config --exists x264 && echo "x264 found via pkg-config" || echo "x264 NOT found via pkg-config"
      pkg-config --exists x265 && echo "x265 found via pkg-config" || echo "x265 NOT found via pkg-config"
      echo "=== Header availability ==="
      find ./conan/include -name "x264.h" -o -name "x265.h" 2>/dev/null || echo "No x264/x265 headers found in conan/include"
      echo "=== Testing library links manually ==="
      echo 'int main(){return 0;}' > test.c
      gcc -I./conan/include -L./conan/lib -lx264 test.c -o test_x264 && echo "Manual x264 link: SUCCESS" || echo "Manual x264 link: FAILED"
      gcc -I./conan/include -L./conan/lib -lx265 test.c -o test_x265 && echo "Manual x265 link: SUCCESS" || echo "Manual x265 link: FAILED"
      rm -f test.c test_x264 test_x265

      echo ./configure --enable-gpl --enable-shared --disable-ffplay --disable-libxcb --disable-vulkan --disable-sdl2 --disable-xlib --enable-tvai --enable-libvpx --enable-libaom --enable-libzimg --enable-nvenc --enable-libx264 --enable-libx265 --enable-nvdec --extra-cflags="-I./conan/include -I./conan/include/videoai" --extra-ldflags="-Wl,-rpath,./conan/lib/ -L./conan/lib" --prefix=./output-conan/
      set -e
      ./configure --enable-gpl --enable-shared --disable-ffplay --disable-libxcb --disable-vulkan --disable-sdl2 --disable-xlib --enable-tvai --enable-libvpx --enable-libaom --enable-libzimg --enable-nvenc --enable-nvdec --enable-libx264 --enable-libx265  --extra-cflags="-I./conan/include -I./conan/include/videoai" --extra-ldflags="-Wl,-rpath,./conan/lib/ -L./conan/lib" --prefix=./output-conan/
      
    displayName: Apply patch and configure
    
  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      
      make clean
      make -j$(nproc) install
      
      if [[ "${BUILD_REASON}" == "PullRequest" || -z "${PUBLISH}" ]]; then
        exit 0
      else
        mkdir -p $(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/linux_x86_64/build_type\=Release/
        cp build-scripts/deploy_conanfile.py $(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/conanfile.py
        cp -Rp "output-conan"/* $(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/linux_x86_64/build_type\=Release/
        cd $(Build.SourcesDirectory)/topaz-conan-dev
        bash ./run_publish_prebuilt.sh --package-name topaz-ffmpeg --package-version $(VERSION) -r topaz-conan
      fi
    displayName: Build FFmpeg

  - bash: |
      cp "$(Build.SourcesDirectory)/pipeline-helper/dependency-manager/dependency_viewer.py" "$(Build.SourcesDirectory)/FFmpeg/build-scripts"
      cd "$(Build.SourcesDirectory)/FFmpeg/build-scripts"

      cp ./linux/profile_ubuntu22.04 ./profile_ubuntu22.04

      python dependency_viewer.py -os=LIN -ar=x86_64 -v="$(VERSION)" -bn="$BUILD_NOTE" -a="$(Build.RequestedFor)" -cf="deploy_conanfile.py"
    condition: and(succeeded(), ne(variables['PUBLISH'], ''))
    displayName: Slack Dependency Manager
    continueOnError: true 
    env:
      DEPENDENCY_MANAGER_SLACK_WEBHOOK: $(DEPENDENCY_MANAGER_SLACK_WEBHOOK)
      BUILD_TYPE: ""
