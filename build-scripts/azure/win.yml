parameters:
 - name: arch
   displayName: build arch
   type: string
   default: AMD64

steps:
  - checkout: self
  - checkout: topaz-conan-dev
  - checkout: nv-codec-headers
    
  - template: set_tools_and_deps.yml
    parameters:
      OS: 'win'
      SHOULD_RESTORE_CONAN_CACHE: true

  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      unix2dos ./build-scripts/win/configure-win.patch
      git apply ./build-scripts/win/configure-win.patch
      git apply ./build-scripts/configure-zimg.patch
      git apply ./build-scripts/configure-aom.patch
      git apply ./build-scripts/intmath.patch
    displayName: Apply patches
  
  - ${{ if eq(parameters.arch, 'ARM64') }}:
      - script: |
          @echo off
          setlocal enabledelayedexpansion
          
          REM Find Visual Studio installation path first
          for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath`) do (
            set "VSPATH=%%i"
          )
          echo Visual Studio found at: !VSPATH!
          echo Calling vcvarsall.bat for x64
          call "!VSPATH!\VC\Auxiliary\Build\vcvarsall.bat" x64

          cd "$(Build.SourcesDirectory)/FFmpeg"
          echo "Building bin2c_x64.exe to prep for arm64 build"

          echo "Prep deps"
          conan install ./build-scripts/conanfile-x64.py -u -pr:b ./build-scripts/win/profile_win2022 -pr:h ./build-scripts/win/profile_win2022 -of ./conan-x64

          echo "Build bin2c_x64.exe"
          set MSYSTEM=MINGW64
          C:\msys64\msys2_shell.cmd -defterm -no-start -mingw64 -c "$(cygpath '$(Build.SourcesDirectory)/FFmpeg/build-scripts/win/build_win_prep.sh') AMD64"

        displayName: Build bin2c_x64.exe

      - bash: |
          cd "$(Build.SourcesDirectory)/FFmpeg"
          git apply ./build-scripts/win/bin2c_x64.patch
        displayName: Apply bin2c_x64.patch
  
  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      bash ./build-scripts/win/conan_win.sh "${{ parameters.arch }}"
    displayName: Install conan packages

  - script: |
      @echo off
      setlocal enabledelayedexpansion
      
      REM Find Visual Studio installation path first
      for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath`) do (
        set "VSPATH=%%i"
      )
      echo Visual Studio found at: !VSPATH!
      
      IF "${{ parameters.arch }}" == "AMD64" (
        echo Calling vcvarsall.bat for x64
        call "!VSPATH!\VC\Auxiliary\Build\vcvarsall.bat" x64
      )
      IF "${{ parameters.arch }}" == "ARM64" (
        echo Calling vcvarsall.bat for amd64_arm64
        call "!VSPATH!\VC\Auxiliary\Build\vcvarsall.bat" amd64_arm64
      )

      cd /d "C:\msys64"
      set MSYSTEM=MINGW64

      IF "${{ parameters.arch }}" == "ARM64" (
        echo "Building arm64"
        C:\msys64\msys2_shell.cmd -defterm -no-start -mingw64 -c "$(cygpath '$(Build.SourcesDirectory)/FFmpeg/build-scripts/win/build_win_post.sh') 'ARM64'"
      )
      IF "${{ parameters.arch }}" == "AMD64" (
        echo "Building amd64"
        C:\msys64\msys2_shell.cmd -defterm -no-start -mingw64 -c "$(cygpath '$(Build.SourcesDirectory)/FFmpeg/build-scripts/win/build_win.sh') 'AMD64'"
      )
    displayName: Set up MSVC toolchain and build

  - bash: |
      cd "$(Build.SourcesDirectory)/FFmpeg"
      if [[ "${BUILD_REASON}" == "PullRequest" || -z "${PUBLISH}" ]]; then
        exit 0
      else
        if [[ "${{ parameters.arch }}" == "AMD64" ]]; then
        mkdir -p "$(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/windows_x86_64_2022/build_type=Release/"
        cp build-scripts/deploy_conanfile.py "$(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/conanfile.py"
        cp -Rp "output-conan"/* "$(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/windows_x86_64_2022/build_type=Release/"
        elif [[ "${{ parameters.arch }}" == "ARM64" ]]; then
          mkdir -p "$(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/windows_armv8_2022/build_type=Release/"
          cp build-scripts/deploy_conanfile.py "$(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/conanfile.py"
          cp -Rp "output-conan"/* "$(Build.SourcesDirectory)/topaz-conan-dev/prebuilt/topaz-ffmpeg/$(VERSION)/windows_armv8_2022/build_type=Release/"
        fi
        cd "$(Build.SourcesDirectory)/topaz-conan-dev"
        ./run_publish_prebuilt.sh --package-name topaz-ffmpeg --package-version "$(VERSION)" -r topaz-conan
      fi
    displayName: Publish to conan
